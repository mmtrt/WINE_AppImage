#!/bin/bash

# exit if any command fails
set -e

# read WINEPREFIX from environment, with fallback if unset
WINEPREFIX=${WINEPREFIX}

# make sure the WINEPREFIX directory exists
if [ ! -d "${WINEPREFIX}" ]; then
    wineboot -u
fi

# define possible locations for wineasio DLLs
u32=(
"/opt/wine-devel/lib/wine/i386-unix/wineasio32.so"
"/opt/wine-stable/lib/wine/i386-unix/wineasio32.so"
"/opt/wine-staging/lib/wine/i386-unix/wineasio32.so"
)

u64=(
"/opt/wine-devel/lib64/wine/x86_64-unix/wineasio64.so"
"/opt/wine-stable/lib64/wine/x86_64-unix/wineasio64.so"
"/opt/wine-staging/lib64/wine/x86_64-unix/wineasio64.so"
)

# try to register 32bit DLL
for u in ${u32[@]}; do
    w=$(echo ${u} | sed -e 's|/i386-unix/wineasio32.so|/i386-windows/wineasio32.dll|g')
    if [ -e "${u}" ] && [ -e "${w}" ]; then
        cp -v "${w}" "${WINEPREFIX}/drive_c/windows/syswow64"
        regsvr32 "${u}"
        break
    fi
done

# try to register 64bit DLL
for u in ${u64[@]}; do
    w=$(echo ${u} | sed -e 's|/x86_64-unix/wineasio64.so|/x86_64-windows/wineasio64.dll|g')
    if [ -e "${u}" ] && [ -e "${w}" ]; then
        cp -v "${w}" "${WINEPREFIX}/drive_c/windows/system32"
        wine64 regsvr32 "${u}"
        break
    fi
done
